<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vertical Video Player</title>
    
    <!-- OpenGraph Metadata -->
    <meta property="og:title" content="Inspirational Moments" />
    <meta property="og:type" content="website" />
    <meta property="og:description" content="A full-screen, vertical video player for motivational quotes, GIFs, and audio." />
    <meta property="og:image" content="https://placehold.co/1200x630/000000/FFFFFF?text=Inspirational+Moments" />
    <meta property="og:url" content="https://example.com" /> <!-- Replace with your actual URL -->
    <meta name="twitter:card" content="summary_large_image">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar hiding for a cleaner look */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        /* Fade-in-out animation for UI icons */
        .fade-in-out {
            animation: fadeInOut 1s ease-in-out;
        }
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }
        /* Text shadow for readability */
        .text-shadow-outline {
            text-shadow: 
                -1px -1px 0 #000,  
                 1px -1px 0 #000,
                -1px  1px 0 #000,
                 1px  1px 0 #000,
                 0 0 8px rgba(0,0,0,0.6); /* Additional subtle shadow */
        }
    </style>
</head>
<body class="bg-black text-white font-sans overflow-hidden">

    <!-- Loading overlay for image generation -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-75 flex-col items-center justify-center z-50 hidden">
        <div class="text-white text-2xl mb-4">Generating Image...</div>
        <div class="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-white"></div>
        <div id="loading-progress" class="text-white mt-4 text-lg"></div>
    </div>

    <!-- Main container for the video player -->
    <div id="video-container" class="relative h-screen w-screen overflow-y-auto snap-y snap-mandatory scroll-smooth no-scrollbar">
        <!-- Video slides will be dynamically inserted here -->
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            //======================================================================
            // CONFIGURATION & STATE MANAGEMENT
            //======================================================================

            const CONFIG = {
                bufferRange: 2, // Number of slides to preload in each direction (up/down)
            };

            const STATE = {
                contentSources: [], // This will be populated by our API call
                currentVideoIndex: 0,
                isMuted: true, // Start muted for autoplay compatibility
                isFetching: false, // Flag to prevent multiple simultaneous API calls
            };
            
            // DOM element references
            const videoContainer = document.getElementById('video-container');
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingProgress = document.getElementById('loading-progress');

            // SVG Icons for UI controls
            const ICONS = {
                play: `<svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>`,
                pause: `<svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>`,
                volumeUp: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>`,
                volumeOff: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" clip-rule="evenodd" /><path stroke-linecap="round" stroke-linejoin="round" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" /></svg>`,
                download: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>`,
                share: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.882 13.07 9.283 13 9.683 13h4.634c.4 0 .802.07 1.001.342M8.684 13.342c.711 2.22 2.653 4.272 4.634 4.272s3.923-2.052 4.634-4.272m-8.684 0c.414-.522 1.055-.916 1.742-1.144M10 20h4a2 2 0 002-2V6a2 2 0 00-2-2h-4a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>`
            };
            
            //======================================================================
            // API & ASSET FETCHING
            //======================================================================

            async function fetchContent() {
                console.log("Fetching content...");
                const mockApiContent = [
                    { quote: "The only way to do great work is to love what you do.", gif: "https://i.giphy.com/media/v1.Y2lkPTc5MGI3NjExNTFkbWRscTY4aDZnM3J2dzd0djM4NTY0eGRkcnJkcGc5cnJ2eGU5byZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/U3qYN8S0j3piM/giphy.gif", audio: "https://file-examples.com/storage/fe004d38a368eeea194ea01/2017/11/file_example_MP3_700KB.mp3" },
                    { quote: "Success is not final, failure is not fatal: it is the courage to continue that counts.", gif: "https://i.giphy.com/media/v1.Y2lkPTc5MGI3NjExM3E1azN6ZzZ3Zm1vcnlla2d5c3h5a3Z3cHIyM3hoYWZreDBjYmZnZSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/yoJC2GnSClbPOkV0eA/giphy.gif", audio: "https://file-examples.com/storage/fe004d38a368eeea194ea01/2017/11/file_example_MP3_700KB.mp3" },
                ];
                await new Promise(resolve => setTimeout(resolve, 500));
                return mockApiContent.sort(() => Math.random() - 0.5);
            }
            
            //======================================================================
            // UI CREATION & MANIPULATION
            //======================================================================

            function createSlideContainer(index) {
                const slide = document.createElement('div');
                slide.className = 'relative h-screen w-screen snap-start flex items-center justify-center bg-black bg-cover bg-center';
                slide.dataset.index = index;
                return slide;
            }

            function addContentToSlide(slide, content) {
                if (slide.querySelector('audio') || !content) return;
                slide.style.backgroundImage = `url(${content.gif})`;
                
                const audio = document.createElement('audio');
                audio.src = content.audio;
                audio.loop = true;
                audio.playsInline = true;
                audio.preload = 'auto';
                audio.muted = STATE.isMuted;

                const quoteContainer = document.createElement('div');
                quoteContainer.className = 'absolute inset-0 flex items-center justify-center p-8 bg-black bg-opacity-40';
                
                const quoteText = document.createElement('h1');
                quoteText.className = 'text-3xl md:text-4xl font-bold text-center text-white text-shadow-outline';
                quoteText.textContent = content.quote;
                quoteContainer.appendChild(quoteText);

                const overlay = document.createElement('div');
                overlay.className = 'absolute inset-0 flex items-center justify-center opacity-0 transition-opacity duration-300';

                const progressBarContainer = document.createElement('div');
                progressBarContainer.className = 'absolute bottom-0 left-0 w-full h-1 bg-gray-500 bg-opacity-50';
                const progressBar = document.createElement('div');
                progressBar.className = 'h-full bg-white transition-all duration-100 ease-linear';
                progressBar.style.width = '0%';
                progressBarContainer.appendChild(progressBar);

                const actionButtonsContainer = document.createElement('div');
                actionButtonsContainer.className = 'action-buttons absolute top-5 right-5 flex flex-col space-y-4 z-10'; // <-- Position updated
                const downloadButton = document.createElement('button');
                downloadButton.className = 'p-3 rounded-full bg-black bg-opacity-50 hover:bg-opacity-75 transition-opacity';
                downloadButton.innerHTML = ICONS.download;
                downloadButton.title = "Download Image";
                downloadButton.addEventListener('click', () => generateImageForAction(content, { isShare: false }));
                const shareButton = document.createElement('button');
                shareButton.className = 'p-3 rounded-full bg-black bg-opacity-50 hover:bg-opacity-75 transition-opacity';
                shareButton.innerHTML = ICONS.share;
                shareButton.title = "Share Image";
                shareButton.addEventListener('click', () => generateImageForAction(content, { isShare: true }));
                actionButtonsContainer.append(downloadButton, shareButton);
                
                audio.addEventListener('timeupdate', () => {
                    const progress = (audio.currentTime / audio.duration) * 100;
                    progressBar.style.width = `${progress || 0}%`;
                });

                slide.addEventListener('click', (e) => {
                    if (e.target.closest('.mute-button') || e.target.closest('.action-buttons')) return;
                    togglePlayPause(audio, overlay);
                });
                
                slide.append(audio, quoteContainer, overlay, progressBarContainer, actionButtonsContainer);
            }

            function createMuteButton() {
                const muteButton = document.createElement('button');
                muteButton.className = 'mute-button absolute bottom-5 right-5 p-2 rounded-full bg-black bg-opacity-50 z-10';
                muteButton.innerHTML = STATE.isMuted ? ICONS.volumeOff : ICONS.volumeUp;
                muteButton.addEventListener('click', () => {
                    STATE.isMuted = !STATE.isMuted;
                    muteButton.innerHTML = STATE.isMuted ? ICONS.volumeOff : ICONS.volumeUp;
                    document.querySelectorAll('audio').forEach(a => a.muted = STATE.isMuted);
                });
                document.body.appendChild(muteButton);
            }

            //======================================================================
            // PLAYER & IMAGE GENERATION LOGIC
            //======================================================================

            /**
             * Wraps text to fit inside a canvas.
             * @param {CanvasRenderingContext2D} context - The canvas context.
             * @param {string} text - The text to wrap.
             * @param {number} x - The starting x-coordinate.
             * @param {number} y - The starting y-coordinate.
             * @param {number} maxWidth - The maximum width of a line.
             * @param {number} lineHeight - The height of each line.
             */
            function wrapText(context, text, x, y, maxWidth, lineHeight) {
                const words = text.split(' ');
                let line = '';
                let testLine;
                let metrics;
                
                for (let n = 0; n < words.length; n++) {
                    testLine = line + words[n] + ' ';
                    metrics = context.measureText(testLine);
                    if (metrics.width > maxWidth && n > 0) {
                        context.fillText(line, x, y);
                        line = words[n] + ' ';
                        y += lineHeight;
                    } else {
                        line = testLine;
                    }
                }
                context.fillText(line, x, y);
            }


            async function generateImageForAction(content, { isShare }) {
                loadingOverlay.classList.remove('hidden');
                loadingOverlay.classList.add('flex');
                loadingProgress.textContent = 'Loading image...';

                try {
                    const proxyUrl = 'https://cors-proxy.canvas-creations.workers.dev/?';
                    const imageUrl = proxyUrl + encodeURIComponent(content.gif);

                    const image = new Image();
                    image.crossOrigin = "anonymous"; // Important for canvas security
                    image.src = imageUrl;

                    image.onload = () => {
                        loadingProgress.textContent = 'Generating...';
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Set canvas dimensions to match the image
                        canvas.width = image.naturalWidth;
                        canvas.height = image.naturalHeight;

                        // Draw the GIF (first frame) as the background
                        ctx.drawImage(image, 0, 0);

                        // Add a semi-transparent overlay
                        ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        
                        // Set text properties
                        const fontSize = Math.max(24, Math.floor(canvas.width / 15));
                        ctx.font = `bold ${fontSize}px sans-serif`;
                        ctx.fillStyle = 'white';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';

                        // Add text shadow for better readability
                        ctx.shadowColor = 'black';
                        ctx.shadowOffsetX = 2;
                        ctx.shadowOffsetY = 2;
                        ctx.shadowBlur = 4;

                        // Wrap and draw the text
                        const maxWidth = canvas.width * 0.9;
                        const lineHeight = fontSize * 1.2;
                        wrapText(ctx, content.quote, canvas.width / 2, canvas.height / 2, maxWidth, lineHeight);
                        
                        // Convert canvas to blob to prepare for download/share
                        canvas.toBlob(async (blob) => {
                            const imageFile = new File([blob], 'inspirational-quote.png', { type: 'image/png' });

                            if (isShare) {
                                if (navigator.canShare && navigator.canShare({ files: [imageFile] })) {
                                    await navigator.share({
                                        title: 'Inspirational Moment',
                                        text: content.quote,
                                        files: [imageFile],
                                    });
                                } else {
                                    alert("Sharing files is not supported on this browser. Try downloading instead.");
                                }
                            } else {
                                const url = URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = 'inspirational-quote.png';
                                a.click();
                                URL.revokeObjectURL(url);
                            }
                            loadingOverlay.classList.add('hidden');
                            loadingOverlay.classList.remove('flex');
                        }, 'image/png');
                    };

                    image.onerror = () => {
                        throw new Error('Failed to load image for canvas.');
                    };

                } catch (error) {
                    console.error('Error generating image:', error);
                    alert('Could not generate the image. Please try again. Check the console for more details.');
                    loadingOverlay.classList.add('hidden');
                    loadingOverlay.classList.remove('flex');
                }
            }


            async function loadMoreContent() {
                if (STATE.isFetching) return;
                STATE.isFetching = true;
                const newContent = await fetchContent();
                const startIndex = STATE.contentSources.length;
                STATE.contentSources = STATE.contentSources.concat(newContent);
                newContent.forEach((_, i) => {
                    const slide = createSlideContainer(startIndex + i);
                    videoContainer.appendChild(slide);
                    scrollObserver.observe(slide);
                });
                STATE.isFetching = false;
                manageBuffer();
            }

            function togglePlayPause(audio, overlay) {
                if (!audio) return;
                if (audio.paused) {
                    audio.play();
                    overlay.innerHTML = ICONS.play;
                } else {
                    audio.pause();
                    overlay.innerHTML = ICONS.pause;
                }
                overlay.classList.add('fade-in-out');
                setTimeout(() => overlay.classList.remove('fade-in-out'), 1000);
            }

            function manageBuffer() {
                document.querySelectorAll('#video-container > div').forEach((slide) => {
                    const index = parseInt(slide.dataset.index, 10);
                    const isInBufferZone = Math.abs(index - STATE.currentVideoIndex) <= CONFIG.bufferRange;
                    const hasContent = slide.querySelector('audio');

                    if (isInBufferZone) {
                        if (!hasContent) addContentToSlide(slide, STATE.contentSources[index]);
                    } else {
                        if (hasContent) slide.innerHTML = '';
                    }
                });
            }

            //======================================================================
            // OBSERVERS & EVENT LISTENERS
            //======================================================================

            const scrollObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const audio = entry.target.querySelector('audio');
                    if (entry.isIntersecting) {
                        if (audio) audio.play().catch(e => console.error("Autoplay failed:", e.message));
                        STATE.currentVideoIndex = parseInt(entry.target.dataset.index, 10);
                        manageBuffer();
                        const isNearEnd = STATE.currentVideoIndex >= STATE.contentSources.length - CONFIG.bufferRange;
                        if (isNearEnd) loadMoreContent();
                    } else {
                        if (audio) audio.pause();
                    }
                });
            }, { threshold: 0.5 });

            function setupKeyboardControls() {
                window.addEventListener('keydown', (e) => {
                    const slides = [...document.querySelectorAll('#video-container > div')];
                    if (e.key === 'ArrowDown') slides[STATE.currentVideoIndex + 1]?.scrollIntoView();
                    if (e.key === 'ArrowUp') slides[STATE.currentVideoIndex - 1]?.scrollIntoView();
                });
            }
            
            //======================================================================
            // INITIALIZATION
            //======================================================================

            async function init() {
                await loadMoreContent(); // Initial load
                manageBuffer();
                createMuteButton();
                setupKeyboardControls();
                setTimeout(() => {
                    document.querySelector('div[data-index="0"] audio')?.play().catch(e => console.error("Initial play failed:", e.message));
                }, 200);
            }

            init();
        });
    </script>
</body>
</html>

